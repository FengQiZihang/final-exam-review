# 第4章 IP层协议

## 核心知识点

---

### 1. IP协议的核心作用、服务特性

#### IP协议的核心作用

**IP（Internet Protocol）协议**是网络层最核心的协议，主要功能：

| 功能 | 描述 |
|------|------|
| **逻辑寻址** | 为每个主机分配唯一的 IP 地址 |
| **路由选择** | 确定数据包从源到目的的传输路径 |
| **分组转发** | 将数据包逐跳转发到目的地 |
| **分片与重组** | 处理不同网络的 MTU 差异 |

#### 服务特性：尽力而为（Best Effort）

| 特性 | 描述 |
|------|------|
| **无连接** | 发送前不需要建立连接 |
| **不可靠** | 不保证数据包一定到达，不保证按序到达 |
| **无确认** | 不对数据包的到达进行确认 |
| **无重传** | 丢失的数据包不会自动重传 |

> **为什么采用"尽力而为"？**
> - 简化网络层设计，提高效率
> - 可靠性由上层（TCP）保证
> - 适应不同应用的需求（有些应用不需要可靠传输）

---

### 2. IPv4 地址分类及特殊地址

#### IPv4 地址结构

- **长度**：32 位（4 字节）
- **表示法**：点分十进制（如 192.168.1.1）
- **组成**：网络号 + 主机号

#### 五类 IP 地址

| 类别 | 首位 | 网络号位数 | 主机号位数 | 地址范围 | 默认子网掩码 |
|------|------|------------|------------|----------|--------------|
| **A类** | 0 | 8 位 | 24 位 | 1.0.0.0 ~ 126.255.255.255 | 255.0.0.0 |
| **B类** | 10 | 16 位 | 16 位 | 128.0.0.0 ~ 191.255.255.255 | 255.255.0.0 |
| **C类** | 110 | 24 位 | 8 位 | 192.0.0.0 ~ 223.255.255.255 | 255.255.255.0 |
| **D类** | 1110 | - | - | 224.0.0.0 ~ 239.255.255.255 | 组播地址 |
| **E类** | 1111 | - | - | 240.0.0.0 ~ 255.255.255.255 | 保留实验 |

> **快速判断**：看第一个字节
> - A类：1-126
> - B类：128-191
> - C类：192-223
> - D类：224-239
> - E类：240-255

#### 特殊 IP 地址

| 类型 | 格式 | 示例 | 用途 |
|------|------|------|------|
| **网络地址** | 主机号全为 0 | 192.168.1.0 | 标识一个网络 |
| **广播地址** | 主机号全为 1 | 192.168.1.255 | 向网络内所有主机发送 |
| **环回地址** | 127.x.x.x | 127.0.0.1 | 本机测试（localhost） |
| **私有地址** | 见下表 | - | 内网使用，不可直接上网 |
| **全0地址** | 0.0.0.0 | - | 表示本网络或默认路由 |
| **全1地址** | 255.255.255.255 | - | 有限广播（本网络广播） |

#### 私有 IP 地址范围

| 类别 | 地址范围 | 网络数量 |
|------|----------|----------|
| **A类** | 10.0.0.0 ~ 10.255.255.255 | 1 个 A 类网 |
| **B类** | 172.16.0.0 ~ 172.31.255.255 | 16 个 B 类网 |
| **C类** | 192.168.0.0 ~ 192.168.255.255 | 256 个 C 类网 |

---

### 3. 子网划分的原理、子网掩码的作用及计算方法

#### 子网划分的原理

**目的**：将一个大网络划分为多个较小的子网，提高 IP 地址利用率

**方法**：从主机号中借用若干位作为子网号

```
原始：| 网络号 |        主机号        |
划分：| 网络号 | 子网号 |   主机号   |
```

#### 子网掩码的作用

**子网掩码（Subnet Mask）**：用于区分 IP 地址中的网络部分和主机部分

- **网络部分**：对应位为 1
- **主机部分**：对应位为 0

**核心运算**：IP 地址 AND 子网掩码 = 网络地址

#### 子网划分计算方法

**例题**：将 192.168.1.0/24 划分为 4 个子网

1. **确定借用位数**：2^n ≥ 子网数量 → 2^2 = 4，借 2 位
2. **新子网掩码**：/24 + 2 = /26 → 255.255.255.192
3. **每个子网主机数**：2^(32-26) - 2 = 62 台
4. **子网划分结果**：

| 子网 | 网络地址 | 可用范围 | 广播地址 |
|------|----------|----------|----------|
| 1 | 192.168.1.0/26 | .1 ~ .62 | 192.168.1.63 |
| 2 | 192.168.1.64/26 | .65 ~ .126 | 192.168.1.127 |
| 3 | 192.168.1.128/26 | .129 ~ .190 | 192.168.1.191 |
| 4 | 192.168.1.192/26 | .193 ~ .254 | 192.168.1.255 |

#### 常用子网掩码对照表

| CIDR | 子网掩码 | 主机数（-2） |
|------|----------|--------------|
| /24 | 255.255.255.0 | 254 |
| /25 | 255.255.255.128 | 126 |
| /26 | 255.255.255.192 | 62 |
| /27 | 255.255.255.224 | 30 |
| /28 | 255.255.255.240 | 14 |
| /29 | 255.255.255.248 | 6 |
| /30 | 255.255.255.252 | 2 |

---

### 4. CIDR 技术（无分类域间路由）

#### CIDR 特点

**CIDR（Classless Inter-Domain Routing）**：无分类域间路由

| 特点 | 描述 |
|------|------|
| **消除传统分类** | 不再区分 A/B/C 类，灵活分配地址 |
| **可变长子网掩码** | 支持 VLSM（Variable Length Subnet Mask） |
| **路由聚合** | 多个网络合并为一个大网络，减少路由表条目 |
| **提高地址利用率** | 按需分配，减少浪费 |

#### 斜线记法（CIDR 记法）

格式：**IP地址/前缀长度**

- 例：192.168.1.0/24 表示前 24 位是网络部分
- 等价于子网掩码 255.255.255.0

#### 路由聚合（超网/CIDR 聚合）

**目的**：将多个连续的小网络合并为一个大网络，减少路由表条目

**例题**：聚合以下 4 个网络
- 192.168.0.0/24
- 192.168.1.0/24
- 192.168.2.0/24
- 192.168.3.0/24

**方法**：找到公共前缀
```
192.168.0.0 = 11000000.10101000.000000|00.00000000
192.168.1.0 = 11000000.10101000.000000|01.00000000
192.168.2.0 = 11000000.10101000.000000|10.00000000
192.168.3.0 = 11000000.10101000.000000|11.00000000
                                      ↑ 前22位相同
```

**结果**：192.168.0.0/22（聚合后的超网）

---

### 5. ARP 协议的作用、工作原理、缓存机制

#### ARP 协议的作用

**ARP（Address Resolution Protocol）**：地址解析协议

- **功能**：将 **IP 地址** 解析为 **MAC 地址**
- **位置**：网络层与数据链路层之间
- **适用**：同一局域网内的地址解析

#### 工作原理

```
┌─────────────────────────────────────────────────────────────┐
│  1. 主机 A 要发送数据给 主机 B（已知 B 的 IP，不知 MAC）      │
│                                                              │
│  2. A 广播 ARP Request（目标 IP = B 的 IP）                  │
│     "谁是 192.168.1.2？请告诉 192.168.1.1"                   │
│                           ↓ 广播                             │
│  ┌────┐    ┌────┐    ┌────┐    ┌────┐                       │
│  │ A  │    │ B  │    │ C  │    │ D  │                       │
│  └────┘    └────┘    └────┘    └────┘                       │
│               │                                              │
│               ↓ 单播                                         │
│  3. B 单播 ARP Reply（我的 MAC 是 xx:xx:xx:xx:xx:xx）        │
│                                                              │
│  4. A 收到后，将 IP-MAC 映射存入 ARP 缓存                    │
└─────────────────────────────────────────────────────────────┘
```

| 步骤 | 报文类型 | 发送方式 | 内容 |
|------|----------|----------|------|
| 请求 | ARP Request | **广播** | 目标 IP，请求对方 MAC |
| 响应 | ARP Reply | **单播** | 发送方 IP 和 MAC |

#### ARP 缓存机制

| 特性 | 描述 |
|------|------|
| **缓存表** | 存储 IP 与 MAC 的映射关系 |
| **生存时间** | 默认 20 分钟（Windows），超时自动删除 |
| **动态更新** | 收到 ARP 报文后自动更新 |
| **查看命令** | `arp -a`（Windows/Linux） |

---

### 6. IPv4 分组格式及校验和计算

#### IPv4 首部格式（20 字节固定 + 可选）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |    ToS/DS     |          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|     Fragment Offset     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  TTL  |    Protocol   |         Header Checksum               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options (可选)                 |  Padding  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 各字段含义

| 字段 | 位数 | 含义 |
|------|------|------|
| **Version** | 4 | IP 版本（IPv4 = 4） |
| **IHL** | 4 | 首部长度，单位 4 字节（最小 5 = 20 字节） |
| **ToS/DS** | 8 | 服务类型/区分服务 |
| **Total Length** | 16 | 整个 IP 分组长度（首部 + 数据），最大 65535 字节 |
| **Identification** | 16 | 分片标识，同一分组的分片具有相同 ID |
| **Flags** | 3 | 标志位：DF（禁止分片）、MF（更多分片） |
| **Fragment Offset** | 13 | 分片偏移，单位 8 字节 |
| **TTL** | 8 | 生存时间，每经过一个路由器减 1，为 0 丢弃 |
| **Protocol** | 8 | 上层协议（1=ICMP，6=TCP，17=UDP） |
| **Header Checksum** | 16 | 首部校验和 |
| **Source Address** | 32 | 源 IP 地址 |
| **Destination Address** | 32 | 目的 IP 地址 |

#### 校验和计算方法

1. **发送方**：
   - 将校验和字段置为 0
   - 将首部按 16 位分组，逐一相加
   - 若有进位，加到低位（回卷）
   - 取反码，填入校验和字段

2. **接收方**：
   - 将首部（包括校验和）按 16 位分组相加
   - 若结果全为 1（0xFFFF），校验通过

---

### 7. IP 分组分片与重组

#### 触发条件

**MTU（Maximum Transmission Unit）**：最大传输单元，数据链路层一帧能承载的最大数据量

- 以太网 MTU：**1500 字节**
- 当 IP 分组大小 > 链路 MTU 时，需要分片

#### 分片机制

| 字段 | 作用 |
|------|------|
| **Identification** | 标识符，同一分组的所有分片相同 |
| **DF（Don't Fragment）** | 禁止分片标志，为 1 则不允许分片 |
| **MF（More Fragments）** | 更多分片标志，为 1 表示后面还有分片 |
| **Fragment Offset** | 分片偏移量，单位 8 字节 |

#### 分片示例

原始分组：4000 字节数据 + 20 字节首部 = 4020 字节
MTU：1500 字节（数据最多 1480 字节，因为每个分片都有 20 字节首部）

| 分片 | 数据长度 | MF | 偏移量 |
|------|----------|----|----|
| 1 | 1480 | 1 | 0 |
| 2 | 1480 | 1 | 185（1480/8） |
| 3 | 1040 | 0 | 370（2960/8） |

#### 重组机制

- **位置**：只在**目的主机**进行重组，中间路由器不负责
- **依据**：根据 Identification、MF、Fragment Offset 重组
- **超时**：若在规定时间内未收齐所有分片，丢弃已收到的

---

### 8. ICMP 协议的作用、报文类型及应用

#### ICMP 协议的作用

**ICMP（Internet Control Message Protocol）**：网络控制消息协议

- **功能**：报告网络层差错和控制信息
- **位置**：网络层协议，封装在 IP 分组中
- **协议号**：1

#### 报文类型

| 类型 | 名称 | 分类 | 说明 |
|------|------|------|------|
| **0** | Echo Reply | 查询报文 | ping 响应 |
| **3** | Destination Unreachable | 差错报文 | 目的不可达 |
| **4** | Source Quench | 差错报文 | 源站抑制（已弃用） |
| **5** | Redirect | 差错报文 | 重定向 |
| **8** | Echo Request | 查询报文 | ping 请求 |
| **11** | Time Exceeded | 差错报文 | 超时（TTL=0） |
| **12** | Parameter Problem | 差错报文 | 参数问题 |

#### ICMP 报文分类

| 分类 | 描述 | 常见类型 |
|------|------|----------|
| **差错报文** | 报告 IP 分组处理中的错误 | 3（不可达）、5（重定向）、11（超时） |
| **查询报文** | 用于诊断和测试 | 8/0（Echo）、13/14（时间戳） |

#### ICMP 应用

**1. ping 命令**
- **功能**：测试主机可达性和网络延迟
- **原理**：发送 ICMP Echo Request（类型 8），等待 Echo Reply（类型 0）

```
C:\> ping 192.168.1.1

正在 Ping 192.168.1.1 具有 32 字节的数据:
来自 192.168.1.1 的回复: 字节=32 时间<1ms TTL=64
```

**2. traceroute / tracert 命令**
- **功能**：追踪数据包经过的路由路径
- **原理**：
  1. 发送 TTL=1 的探测包，第一跳路由器返回 ICMP Time Exceeded
  2. TTL 逐渐增加，记录每一跳的响应
  3. 直到到达目的地或达到最大跳数

```
C:\> tracert www.example.com

  1    <1 ms    <1 ms    <1 ms  192.168.1.1
  2     5 ms     4 ms     5 ms  10.0.0.1
  3    20 ms    18 ms    19 ms  目的地
```

---

## 重点对比总结

### IP 分类地址 vs CIDR

| 对比项 | 分类地址 | CIDR |
|--------|----------|------|
| 地址划分 | 固定的 A/B/C 类 | 可变长前缀 |
| 灵活性 | 低，浪费严重 | 高，按需分配 |
| 路由表 | 条目多 | 支持聚合，条目少 |
| 子网掩码 | 固定默认值 | 支持 VLSM |

### ARP vs RARP

| 对比项 | ARP | RARP |
|--------|-----|------|
| 功能 | IP → MAC | MAC → IP |
| 使用场景 | 通信前获取 MAC | 无盘工作站获取 IP |
| 当前状态 | 广泛使用 | 已被 DHCP 取代 |

---

## 常见考点速记

1. **IP 协议特点**：无连接、不可靠、尽力而为
2. **IPv4 地址长度**：32 位（4 字节）
3. **私有地址**：10.x.x.x、172.16-31.x.x、192.168.x.x
4. **环回地址**：127.0.0.1（localhost）
5. **ARP**：IP → MAC，广播请求、单播响应
6. **IP 首部固定长度**：20 字节
7. **TTL**：每经过一个路由器减 1
8. **分片在目的主机重组**，不在中间路由器
9. **ICMP 类型 8/0**：ping（Echo Request/Reply）
10. **ICMP 类型 11**：TTL 超时（traceroute 使用）
