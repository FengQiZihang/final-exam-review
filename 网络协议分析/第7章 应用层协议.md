# 第7章 应用层协议

## 核心知识点

---

### 1. DNS 协议的功能、域名空间结构、域名服务器类型

#### DNS 协议功能

**DNS（Domain Name System）**：域名系统

| 功能 | 描述 |
|------|------|
| **域名解析** | 将域名转换为 IP 地址（正向解析） |
| **反向解析** | 将 IP 地址转换为域名 |
| **负载均衡** | 一个域名对应多个 IP，实现负载分担 |

- **传输协议**：UDP（端口 53），大数据量时使用 TCP
- **特点**：分布式、层次化的命名系统

#### 域名空间结构（分层）

```
                        . (根)
                        │
        ┌───────────────┼───────────────┐
        │               │               │
       com             org             cn    ← 顶级域
        │               │               │
    ┌───┴───┐       ┌───┴───┐       ┌───┴───┐
  google  example  wikipedia     baidu    edu  ← 二级域
    │       │                      │       │
   www    mail                    www    tsinghua ← 三级域
```

| 层级 | 示例 | 描述 |
|------|------|------|
| **根域** | . | 最顶层，由 13 组根服务器管理 |
| **顶级域（TLD）** | .com .org .cn .edu | 通用顶级域和国家顶级域 |
| **二级域** | google.com baidu.cn | 组织/企业注册的域名 |
| **三级域及以下** | www.google.com | 主机名或子域名 |

> **完整域名（FQDN）**：www.example.com.（结尾有根域点号）

#### 域名服务器类型

| 类型 | 描述 | 数量/示例 |
|------|------|-----------|
| **根域名服务器** | 管理顶级域信息，知道所有 TLD 服务器地址 | 全球 13 组（A~M） |
| **顶级域名服务器（TLD）** | 管理该顶级域下的所有二级域 | .com 服务器、.cn 服务器 |
| **权限域名服务器** | 负责特定域的解析，存储该域的权威记录 | google.com 的 DNS 服务器 |
| **本地域名服务器** | 用户首先查询的服务器，有缓存功能 | ISP 或企业的 DNS 服务器 |

---

### 2. DNS 解析过程及报文格式

#### DNS 解析过程

##### 递归查询（Recursive Query）

客户端只发一次请求，由本地 DNS 服务器代为完成全部查询

```
客户端 ──► 本地DNS ──► 根DNS ──► TLD ──► 权限DNS
                 ◄──────────────────────────────
                         递归返回结果
```

##### 迭代查询（Iterative Query）

本地 DNS 服务器收到"参考回答"后自己继续查询

```
客户端 ──► 本地DNS
              │
              ├──► 根DNS ◄── "去问 .com 服务器"
              │
              ├──► .com TLD ◄── "去问 example.com 权限服务器"
              │
              └──► 权限DNS ◄── 返回最终 IP
          │
          ▼
        返回给客户端
```

#### 典型解析流程（以 www.example.com 为例）

| 步骤 | 发起方 | 查询对象 | 返回内容 |
|------|--------|----------|----------|
| 1 | 客户端 | 本地 DNS | - |
| 2 | 本地 DNS | 根服务器 | .com TLD 服务器地址 |
| 3 | 本地 DNS | .com TLD | example.com 权限服务器地址 |
| 4 | 本地 DNS | 权限服务器 | www.example.com 的 IP |
| 5 | 本地 DNS | 客户端 | 返回 IP 并缓存 |

#### DNS 报文格式

```
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      ID                       |  事务标识
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|QR|  Opcode |AA|TC|RD|RA|   Z    |   RCODE     |  标志
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QDCOUNT                    |  问题数
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ANCOUNT                    |  回答数
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NSCOUNT                    |  授权数
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ARCOUNT                    |  附加数
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                   Questions                   |  查询问题
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    Answers                    |  回答资源记录
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

| 字段 | 描述 |
|------|------|
| **QR** | 0=查询，1=响应 |
| **AA** | 权威回答标志 |
| **RD** | 期望递归 |
| **RA** | 支持递归 |
| **RCODE** | 返回码（0=成功，3=域名不存在） |

#### 常见资源记录类型

| 类型 | 名称 | 含义 |
|------|------|------|
| **A** | Address | 域名 → IPv4 地址 |
| **AAAA** | IPv6 Address | 域名 → IPv6 地址 |
| **CNAME** | Canonical Name | 别名记录 |
| **MX** | Mail Exchange | 邮件交换记录 |
| **NS** | Name Server | 域名服务器记录 |
| **PTR** | Pointer | IP → 域名（反向解析） |

---

### 3. DHCP 协议的功能、工作流程及报文种类

#### DHCP 协议功能

**DHCP（Dynamic Host Configuration Protocol）**：动态主机配置协议

| 功能 | 描述 |
|------|------|
| **自动分配 IP 地址** | 客户端无需手动配置 |
| **分配网络参数** | 子网掩码、网关、DNS 服务器等 |
| **地址复用** | 租期到期后回收，分配给其他主机 |
| **简化管理** | 集中管理 IP 地址池 |

- **传输协议**：UDP
- **端口**：服务器 67，客户端 68

#### DHCP 工作流程（DORA）

```
      客户端                                    DHCP服务器
         │                                          │
   ① DISCOVER                                       │
         │ ──────────────(广播)─────────────────► │
         │    "谁能给我分配IP地址？"                 │
         │                                          │
   ② OFFER                                          │
         │ ◄─────────────(广播/单播)──────────────  │
         │    "我可以，给你 192.168.1.100"          │
         │                                          │
   ③ REQUEST                                        │
         │ ──────────────(广播)─────────────────► │
         │    "我选择你提供的地址"                   │
         │                                          │
   ④ ACK                                            │
         │ ◄─────────────(广播/单播)──────────────  │
         │    "确认，地址生效"                       │
         │                                          │
```

| 步骤 | 报文 | 发送方式 | 说明 |
|------|------|----------|------|
| **D - Discover** | DHCPDISCOVER | 广播 | 客户端寻找 DHCP 服务器 |
| **O - Offer** | DHCPOFFER | 广播/单播 | 服务器提供可用 IP |
| **R - Request** | DHCPREQUEST | 广播 | 客户端选择并请求该 IP |
| **A - ACK** | DHCPACK | 广播/单播 | 服务器确认分配 |

> **为什么第三步用广播？** 通知其他 DHCP 服务器"我已经选择了"

#### DHCP 报文种类

| 报文类型 | 方向 | 功能 |
|----------|------|------|
| **DHCPDISCOVER** | 客户端→服务器 | 发现可用的 DHCP 服务器 |
| **DHCPOFFER** | 服务器→客户端 | 提供 IP 地址及配置参数 |
| **DHCPREQUEST** | 客户端→服务器 | 请求使用某个 IP 地址 |
| **DHCPACK** | 服务器→客户端 | 确认地址分配成功 |
| **DHCPNAK** | 服务器→客户端 | 拒绝请求（IP 不可用） |
| **DHCPRELEASE** | 客户端→服务器 | 释放 IP 地址 |
| **DHCPINFORM** | 客户端→服务器 | 请求其他配置信息（已有 IP） |

---

### 4. DHCP 地址分配方式及租用期管理

#### 地址分配方式

| 方式 | 描述 | 适用场景 |
|------|------|----------|
| **静态分配** | 管理员为特定 MAC 地址绑定固定 IP | 服务器、打印机等需要固定 IP 的设备 |
| **动态分配** | 从地址池中动态分配，有租期限制 | 普通客户端，流动性强的环境 |
| **自动分配** | 首次动态分配后永久使用（无租期或超长租期） | 较少使用 |

#### 租用期管理

| 时间点 | 操作 | 说明 |
|--------|------|------|
| **租期开始** | 获得 IP 地址 | 开始计时 |
| **T1（50%租期）** | 单播续租请求 | 向原 DHCP 服务器发送 DHCPREQUEST |
| **T2（87.5%租期）** | 广播续租请求 | 如果 T1 失败，向所有服务器广播 |
| **租期到期** | 释放 IP | 停止使用该 IP，重新 DORA 流程 |

```
|←────── 租期 ──────→|
|────────|────────|──|
0%      50%     87.5% 100%
        T1       T2   到期
```

---

### 5. FTP 协议的功能、C/S 架构、双连接机制

#### FTP 协议功能

**FTP（File Transfer Protocol）**：文件传输协议

| 功能 | 描述 |
|------|------|
| **文件传输** | 上传、下载文件 |
| **目录操作** | 列目录、创建/删除目录 |
| **文件管理** | 重命名、删除文件 |
| **访问控制** | 用户认证、权限管理 |

- **传输协议**：TCP
- **工作模式**：客户端/服务器（C/S）架构

#### FTP 双连接机制

| 连接类型 | 端口（主动模式） | 用途 |
|----------|------------------|------|
| **控制连接** | 服务器 21 | 传输命令和响应，持久连接 |
| **数据连接** | 服务器 20 | 传输文件数据，按需建立 |

##### 主动模式（Active Mode）

```
客户端                           FTP服务器
   │                                │
   │ ──[控制连接：端口21]──────────► │  建立控制连接
   │                                │
   │ "PORT 客户端IP,端口"            │  告知服务器数据端口
   │                                │
   │ ◄──[数据连接：服务器20→客户端]── │  服务器主动连接客户端
   │                                │
```

##### 被动模式（Passive Mode）

```
客户端                           FTP服务器
   │                                │
   │ ──[控制连接：端口21]──────────► │  建立控制连接
   │                                │
   │ "PASV"                         │  请求被动模式
   │ ◄── "服务器IP,数据端口"         │  服务器告知监听端口
   │                                │
   │ ──[数据连接：客户端→服务器]────► │  客户端主动连接服务器
   │                                │
```

> **主动模式问题**：客户端在 NAT/防火墙后时，服务器无法主动连接
> **被动模式优点**：由客户端主动发起所有连接，更适合 NAT 环境

#### FTP 传输模式

| 模式 | 描述 |
|------|------|
| **ASCII 模式** | 文本文件传输，自动转换换行符 |
| **Binary 模式** | 二进制文件传输，原样传输 |

---

### 6. 电子邮件系统组成及核心协议

#### 电子邮件系统组成

```
┌──────────────┐                              ┌──────────────┐
│   发送方      │                              │   接收方      │
│  用户代理     │                              │  用户代理     │
│  (MUA)       │                              │  (MUA)       │
└──────┬───────┘                              └──────▲───────┘
       │ SMTP                                        │ POP3/IMAP
       ▼                                             │
┌──────────────┐         SMTP              ┌──────────────┐
│ 发送方邮件    │ ─────────────────────────► │ 接收方邮件    │
│   服务器      │                           │   服务器      │
│  (MTA)       │                           │  (MTA)       │
└──────────────┘                           └──────────────┘
```

| 组件 | 全称 | 功能 |
|------|------|------|
| **用户代理（MUA）** | Mail User Agent | 撰写、阅读邮件的客户端（Outlook、Foxmail） |
| **邮件服务器（MTA）** | Mail Transfer Agent | 发送、接收、存储邮件 |
| **邮件传输代理** | - | 服务器间传递邮件 |

#### 核心协议

| 协议 | 全称 | 端口 | 功能 |
|------|------|------|------|
| **SMTP** | Simple Mail Transfer Protocol | 25 | 发送邮件（推送） |
| **POP3** | Post Office Protocol v3 | 110 | 接收邮件（拉取，下载后删除） |
| **IMAP** | Internet Message Access Protocol | 143 | 接收邮件（保留在服务器） |

#### SMTP 协议特点

| 特点 | 描述 |
|------|------|
| **推送协议** | 将邮件推送到接收方服务器 |
| **基于 TCP** | 端口 25，可靠传输 |
| **命令/响应模式** | 类似 HTTP |
| **只能传输 ASCII** | 非 ASCII 需要 MIME 编码 |

**常见 SMTP 命令**：

| 命令 | 功能 |
|------|------|
| HELO/EHLO | 客户端自我介绍 |
| MAIL FROM | 指定发件人 |
| RCPT TO | 指定收件人 |
| DATA | 开始传输邮件内容 |
| QUIT | 结束会话 |

#### POP3 vs IMAP

| 对比项 | POP3 | IMAP |
|--------|------|------|
| 邮件存储 | 下载到本地，服务器删除 | 保留在服务器 |
| 多设备访问 | 不方便 | 方便同步 |
| 离线阅读 | 支持 | 部分支持 |
| 服务器压力 | 低 | 高 |
| 端口 | 110 | 143 |

---

### 7. HTTP 协议的功能、URL 格式、请求/响应报文结构

#### HTTP 协议功能

**HTTP（HyperText Transfer Protocol）**：超文本传输协议

| 功能 | 描述 |
|------|------|
| **传输超文本** | HTML 页面、图片、视频等 |
| **请求-响应模式** | 客户端发起请求，服务器返回响应 |
| **无状态** | 每个请求独立，服务器不记忆客户端状态 |

- **传输协议**：TCP
- **端口**：80（HTTP）、443（HTTPS）

#### URL 格式

```
协议://主机名:端口/路径?查询参数#片段

https://www.example.com:443/path/page.html?id=123&name=test#section1
  │          │          │        │              │            │
协议        主机        端口      路径          查询参数      片段
```

| 组成部分 | 描述 | 示例 |
|----------|------|------|
| **协议** | 访问资源使用的协议 | http、https、ftp |
| **主机名** | 服务器域名或 IP | www.example.com |
| **端口** | 可选，默认 80/443 | :8080 |
| **路径** | 资源在服务器上的位置 | /images/logo.png |
| **查询参数** | 传递给服务器的参数 | ?id=123&type=new |
| **片段** | 页面内锚点 | #chapter2 |

#### HTTP 请求报文结构

```
┌────────────────────────────────────────────┐
│  请求行: 方法 URL HTTP版本                  │
├────────────────────────────────────────────┤
│  请求头:                                    │
│    Host: www.example.com                   │
│    User-Agent: Mozilla/5.0                 │
│    Accept: text/html                       │
│    Connection: keep-alive                  │
├────────────────────────────────────────────┤
│  空行                                       │
├────────────────────────────────────────────┤
│  请求体（可选）                              │
└────────────────────────────────────────────┘
```

**示例**：
```
GET /index.html HTTP/1.1
Host: www.example.com
User-Agent: Mozilla/5.0
Accept: text/html
Connection: keep-alive

```

#### HTTP 响应报文结构

```
┌────────────────────────────────────────────┐
│  状态行: HTTP版本 状态码 状态描述            │
├────────────────────────────────────────────┤
│  响应头:                                    │
│    Content-Type: text/html                 │
│    Content-Length: 1234                    │
│    Server: Apache                          │
├────────────────────────────────────────────┤
│  空行                                       │
├────────────────────────────────────────────┤
│  响应体（HTML/JSON/图片等）                  │
└────────────────────────────────────────────┘
```

**示例**：
```
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 1234

<html>...</html>
```

#### 常见状态码

| 状态码 | 类别 | 含义 | 示例 |
|--------|------|------|------|
| **1xx** | 信息 | 请求已接收，继续处理 | 100 Continue |
| **2xx** | 成功 | 请求成功处理 | 200 OK |
| **3xx** | 重定向 | 需要进一步操作 | 301 永久重定向，302 临时重定向 |
| **4xx** | 客户端错误 | 请求有语法错误或无法完成 | 404 Not Found，403 Forbidden |
| **5xx** | 服务器错误 | 服务器处理请求失败 | 500 Internal Error，503 Service Unavailable |

---

### 8. HTTP 方法

#### 常用 HTTP 方法

| 方法 | 描述 | 请求体 | 幂等性 | 安全性 |
|------|------|--------|--------|--------|
| **GET** | 获取资源 | ❌ 无 | ✅ 是 | ✅ 是 |
| **POST** | 提交数据，创建资源 | ✅ 有 | ❌ 否 | ❌ 否 |
| **PUT** | 更新/替换资源 | ✅ 有 | ✅ 是 | ❌ 否 |
| **DELETE** | 删除资源 | ❌ 无 | ✅ 是 | ❌ 否 |
| **HEAD** | 获取响应头（不要响应体） | ❌ 无 | ✅ 是 | ✅ 是 |
| **OPTIONS** | 查询支持的方法 | ❌ 无 | ✅ 是 | ✅ 是 |
| **PATCH** | 部分更新资源 | ✅ 有 | ❌ 否 | ❌ 否 |

#### GET vs POST

| 对比项 | GET | POST |
|--------|-----|------|
| 用途 | 获取数据 | 提交数据 |
| 参数位置 | URL 中（查询字符串） | 请求体中 |
| 数据长度 | 受 URL 长度限制 | 无限制 |
| 可见性 | 参数在 URL 中可见 | 参数不可见 |
| 缓存 | 可以缓存 | 不可缓存 |
| 书签 | 可以保存为书签 | 不可以 |
| 安全性 | 较低（参数可见） | 较高 |

#### 幂等性与安全性

| 概念 | 定义 |
|------|------|
| **幂等性** | 多次执行与一次执行的效果相同 |
| **安全性** | 不会修改服务器上的资源 |

---

## 重点对比总结

### DNS 查询方式对比

| 对比项 | 递归查询 | 迭代查询 |
|--------|----------|----------|
| 查询方 | 本地 DNS 服务器代劳 | 客户端逐级查询 |
| 服务器负担 | 高 | 低 |
| 客户端复杂度 | 低 | 高 |
| 常用场景 | 客户端→本地 DNS | 本地 DNS→其他服务器 |

### 应用层协议端口总结

| 协议 | 端口 | 传输层 | 功能 |
|------|------|--------|------|
| DNS | 53 | UDP/TCP | 域名解析 |
| DHCP | 67/68 | UDP | 动态地址分配 |
| FTP | 20/21 | TCP | 文件传输 |
| SMTP | 25 | TCP | 发送邮件 |
| POP3 | 110 | TCP | 接收邮件 |
| IMAP | 143 | TCP | 接收邮件 |
| HTTP | 80 | TCP | 网页访问 |
| HTTPS | 443 | TCP | 安全网页访问 |

---

## 常见考点速记

1. **DNS 端口**：53/UDP（大数据用 TCP）
2. **DNS 服务器类型**：根、顶级域（TLD）、权限、本地
3. **DNS 查询**：递归（客户端→本地），迭代（本地→其他）
4. **DHCP 端口**：服务器 67，客户端 68
5. **DHCP 流程（DORA）**：Discover、Offer、Request、ACK
6. **DHCP 续租时间**：T1=50%、T2=87.5%
7. **FTP 双连接**：控制(21)、数据(20)
8. **FTP 两种模式**：主动模式（服务器连客户端）、被动模式（客户端连服务器）
9. **邮件协议**：SMTP 发送(25)、POP3 接收(110)、IMAP 接收(143)
10. **HTTP 端口**：80（HTTP）、443（HTTPS）
11. **HTTP 特点**：无状态、请求-响应模式
12. **GET vs POST**：GET 获取数据（URL参数）、POST 提交数据（请求体）
13. **常见状态码**：200 成功、301/302 重定向、404 未找到、500 服务器错误
