# 第6章 传输层协议

## 核心知识点

---

### 1. 传输层的核心作用

#### 进程间逻辑通信

| 层次 | 通信对象 | 地址标识 |
|------|----------|----------|
| **网络层** | 主机到主机 | IP 地址 |
| **传输层** | 进程到进程 | IP 地址 + 端口号 |

> 传输层在网络层提供的主机间通信基础上，实现了**进程间的端到端通信**

#### 弥补网络层服务缺陷

| 网络层（IP）缺陷 | 传输层解决方案 |
|------------------|----------------|
| 不可靠传输 | TCP 提供可靠传输 |
| 无连接 | TCP 提供面向连接服务 |
| 无流量控制 | TCP 提供流量控制 |
| 无拥塞控制 | TCP 提供拥塞控制 |
| 不区分应用 | 通过端口号区分不同应用 |

#### 传输层两大协议

| 协议 | 特点 | 适用场景 |
|------|------|----------|
| **TCP** | 面向连接、可靠、有序、流量/拥塞控制 | 文件传输、网页、邮件 |
| **UDP** | 无连接、不可靠、简单高效 | 视频、语音、DNS、游戏 |

---

### 2. 端口的定义、分类及作用

#### 端口的定义

**端口（Port）**：传输层用于标识进程的 16 位数字（0 ~ 65535）

- **作用**：区分同一主机上的不同应用进程
- **套接字（Socket）**：IP 地址 + 端口号，唯一标识网络中的一个通信端点

#### 端口分类

| 分类 | 端口范围 | 描述 | 示例 |
|------|----------|------|------|
| **熟知端口（Well-Known）** | 0 ~ 1023 | 系统保留，分配给常用服务 | 80(HTTP)、443(HTTPS)、22(SSH) |
| **注册端口（Registered）** | 1024 ~ 49151 | 可注册给特定应用 | 3306(MySQL)、8080 |
| **临时/动态端口（Ephemeral）** | 49152 ~ 65535 | 客户端临时使用 | 随机分配给客户端进程 |

#### 常见熟知端口

| 端口 | 协议 | 服务 |
|------|------|------|
| 20 | TCP | FTP 数据传输 |
| 21 | TCP | FTP 控制连接 |
| 22 | TCP | SSH |
| 23 | TCP | Telnet |
| 25 | TCP | SMTP |
| 53 | UDP/TCP | DNS |
| 67/68 | UDP | DHCP |
| 80 | TCP | HTTP |
| 110 | TCP | POP3 |
| 443 | TCP | HTTPS |

---

### 3. 多路复用与多路分解

#### 多路复用（Multiplexing）

**定义**：发送端将多个应用进程的数据汇聚到传输层，通过同一个网络层发送

```
┌─────────┐ ┌─────────┐ ┌─────────┐
│ 进程 A  │ │ 进程 B  │ │ 进程 C  │   ← 应用层（多个进程）
└────┬────┘ └────┬────┘ └────┬────┘
     │          │          │
     ▼          ▼          ▼
┌────────────────────────────────┐
│         传输层（复用）          │   ← 添加端口号
└─────────────┬──────────────────┘
              ▼
┌────────────────────────────────┐
│            网络层              │   ← 统一发送
└────────────────────────────────┘
```

#### 多路分解（Demultiplexing）

**定义**：接收端根据端口号将数据分发给对应的应用进程

```
┌────────────────────────────────┐
│            网络层              │   ← 统一接收
└─────────────┬──────────────────┘
              ▼
┌────────────────────────────────┐
│         传输层（分解）          │   ← 根据端口号分发
└────┬────────┬────────┬─────────┘
     │        │        │
     ▼        ▼        ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│ 进程 A  │ │ 进程 B  │ │ 进程 C  │   ← 应用层
└─────────┘ └─────────┘ └─────────┘
```

#### 分解依据

| 协议 | 分解依据 |
|------|----------|
| **UDP** | 目的 IP + 目的端口（二元组） |
| **TCP** | 源 IP + 源端口 + 目的 IP + 目的端口（四元组） |

---

### 4. UDP 协议的特点、报文格式及校验和计算

#### UDP 协议特点

| 特点 | 描述 |
|------|------|
| **无连接** | 发送前不需要建立连接 |
| **不可靠** | 不保证交付，不保证顺序 |
| **无流量/拥塞控制** | 尽可能快地发送 |
| **首部开销小** | 仅 8 字节 |
| **支持一对多通信** | 支持广播和组播 |

> **适用场景**：实时性要求高、允许少量丢包（视频、语音、DNS、游戏）

#### UDP 报文格式（8 字节首部）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |           Checksum            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

| 字段 | 位数 | 描述 |
|------|------|------|
| Source Port | 16 | 源端口号 |
| Destination Port | 16 | 目的端口号 |
| Length | 16 | UDP 报文总长度（首部 + 数据） |
| Checksum | 16 | 校验和（可选，IPv6 强制） |

#### UDP 校验和计算

**范围**：伪首部 + UDP 首部 + 数据

**伪首部结构**（12 字节，仅用于校验计算，不实际传输）：
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source IP Address                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination IP Address                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      0        |   Protocol    |          UDP Length           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

### 5. TCP 协议的特点

| 特点 | 描述 |
|------|------|
| **面向连接** | 通信前必须建立连接（三次握手） |
| **可靠传输** | 确认机制、重传机制保证数据正确交付 |
| **全双工** | 双方可同时发送和接收数据 |
| **面向字节流** | 将数据视为无边界的字节流 |
| **流量控制** | 滑动窗口机制，防止发送方过快 |
| **拥塞控制** | 根据网络状况调整发送速率 |
| **点对点** | 只能一对一通信，不支持广播/组播 |

---

### 6. TCP 报文段格式

#### TCP 首部格式（20 字节固定 + 可选）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Offset|  Res  |C|E|U|A|P|R|S|F|            Window             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options (可选)                 |  Padding  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 各字段含义

| 字段 | 位数 | 描述 |
|------|------|------|
| Source Port | 16 | 源端口号 |
| Destination Port | 16 | 目的端口号 |
| **Sequence Number** | 32 | 序号，本报文段第一个字节的编号 |
| **Acknowledgment Number** | 32 | 确认号，期望收到的下一个字节编号 |
| Data Offset | 4 | 首部长度，单位 4 字节 |
| **Window** | 16 | 接收窗口大小，用于流量控制 |
| Checksum | 16 | 校验和（强制） |
| Urgent Pointer | 16 | 紧急指针，URG=1 时有效 |

#### 标志位（Flags）

| 标志 | 名称 | 作用 |
|------|------|------|
| **SYN** | 同步 | 建立连接时置 1 |
| **ACK** | 确认 | 确认号有效时置 1 |
| **FIN** | 结束 | 释放连接时置 1 |
| **RST** | 复位 | 重置连接 |
| **PSH** | 推送 | 要求接收方立即交付应用层 |
| **URG** | 紧急 | 紧急数据，优先处理 |

---

### 7. TCP 连接管理

#### 三次握手建立连接

```
    客户端                                    服务器
      |                                         |
      |  ① SYN=1, seq=x                        |
      |  ─────────────────────────────────────► |
      |         (SYN_SENT)                      |
      |                                         |
      |  ② SYN=1, ACK=1, seq=y, ack=x+1        |
      | ◄───────────────────────────────────── |
      |                              (SYN_RCVD) |
      |                                         |
      |  ③ ACK=1, seq=x+1, ack=y+1             |
      |  ─────────────────────────────────────► |
      |    (ESTABLISHED)            (ESTABLISHED)|
      |                                         |
```

| 步骤 | 发送方 | 报文内容 | 说明 |
|------|--------|----------|------|
| **第一次** | 客户端 | SYN=1, seq=x | 请求建立连接 |
| **第二次** | 服务器 | SYN=1, ACK=1, seq=y, ack=x+1 | 同意建立，确认收到 |
| **第三次** | 客户端 | ACK=1, seq=x+1, ack=y+1 | 确认收到服务器的同意 |

> **为什么需要三次握手？**
> - 防止**失效的连接请求**到达服务器后建立错误连接
> - 确认双方的**发送和接收能力**都正常

#### 四次挥手释放连接

```
    客户端                                    服务器
      |                                         |
      |  ① FIN=1, seq=u                        |
      |  ─────────────────────────────────────► |
      |    (FIN_WAIT_1)                         |
      |                                         |
      |  ② ACK=1, seq=v, ack=u+1               |
      | ◄───────────────────────────────────── |
      |    (FIN_WAIT_2)             (CLOSE_WAIT)|
      |                                         |
      |         ... 服务器发送剩余数据 ...       |
      |                                         |
      |  ③ FIN=1, ACK=1, seq=w, ack=u+1        |
      | ◄───────────────────────────────────── |
      |    (TIME_WAIT)               (LAST_ACK) |
      |                                         |
      |  ④ ACK=1, seq=u+1, ack=w+1             |
      |  ─────────────────────────────────────► |
      |                                (CLOSED) |
      |   等待 2MSL                             |
      |   (CLOSED)                              |
```

| 步骤 | 发送方 | 报文内容 | 说明 |
|------|--------|----------|------|
| **第一次** | 客户端 | FIN=1, seq=u | 请求关闭（客户端→服务器） |
| **第二次** | 服务器 | ACK=1, ack=u+1 | 确认收到关闭请求 |
| **第三次** | 服务器 | FIN=1, ACK=1, seq=w | 请求关闭（服务器→客户端） |
| **第四次** | 客户端 | ACK=1, ack=w+1 | 确认收到，等待 2MSL 后关闭 |

> **为什么需要四次挥手？**
> - TCP 是**全双工**，需要分别关闭两个方向
> - 服务器可能还有数据要发送，不能立即关闭
>
> **为什么要等待 2MSL？**
> - MSL = Maximum Segment Lifetime（最长报文寿命）
> - 确保最后的 ACK 能到达服务器
> - 确保本连接的所有报文从网络中消失

---

### 8. TCP 可靠传输机制

#### 核心机制

| 机制 | 描述 |
|------|------|
| **序号（Sequence Number）** | 每个字节都有编号，保证有序 |
| **确认（ACK）** | 接收方确认已收到的数据 |
| **超时重传** | 未收到确认则重传 |
| **累计确认** | 确认号表示之前所有数据都已收到 |

#### 序号与确认号

- **序号（seq）**：本报文段第一个字节的编号
- **确认号（ack）**：期望收到的下一个字节的编号

```
发送方: [seq=1, 1000字节数据]  ──►  接收方
发送方  ◄──  [ack=1001] 表示1001之前都收到了
```

#### 超时重传机制

```
发送方                           接收方
   |                               |
   | ─── [seq=1] ───────────────► |  发送数据
   |                               |
   | ◄─── [ack=1001] ───────────── |  确认收到
   |                               |
   | ─── [seq=1001] ────── X      |  数据丢失
   |                               |
   | (超时，未收到确认)            |
   |                               |
   | ─── [seq=1001] ───────────► |  重传
   |                               |
```

**RTO（Retransmission Timeout）**：重传超时时间，根据 RTT 动态调整

#### 累计确认

- 确认号 N 表示：序号 N 之前的所有字节都已正确收到
- 优点：减少确认报文数量，即使 ACK 丢失也不影响

---

### 9. TCP 流量控制（滑动窗口机制）

#### 目的

防止发送方发送速度过快，导致接收方缓冲区溢出

#### 滑动窗口机制

**接收窗口（rwnd）**：接收方通过 Window 字段通告自己的缓冲区剩余空间

```
发送方                                       接收方
   |                                           |
   | ◄─── [ack=1, rwnd=4000] ───────────────── |  可发送4000字节
   |                                           |
   | ─── [seq=1, 1000字节] ───────────────────►|
   | ─── [seq=1001, 1000字节] ────────────────►|
   |                                           |
   | ◄─── [ack=2001, rwnd=2000] ────────────── |  窗口缩小至2000
   |                                           |
```

#### 窗口动态调整

| 情况 | 接收方动作 | 发送方响应 |
|------|------------|------------|
| 缓冲区充足 | 通告大窗口 | 可连续发送多个段 |
| 缓冲区紧张 | 通告小窗口 | 减慢发送速度 |
| 缓冲区满 | rwnd = 0 | 停止发送，定期探测 |

#### 零窗口探测

当接收窗口为 0 时，发送方定期发送 1 字节的**探测报文**，等待窗口重新打开

---

### 10. TCP 拥塞控制

#### 目的

防止发送方注入过多数据到网络，导致网络拥塞

#### 核心概念

| 概念 | 描述 |
|------|------|
| **拥塞窗口（cwnd）** | 发送方根据网络状况维护的窗口大小 |
| **慢启动阈值（ssthresh）** | 慢启动与拥塞避免的切换点 |
| **发送窗口** | min(cwnd, rwnd)，实际发送量 |

#### 四种算法

##### 1. 慢启动（Slow Start）

- **初始**：cwnd = 1 MSS
- **规则**：每收到一个 ACK，cwnd 翻倍（指数增长）
- **终止**：cwnd ≥ ssthresh 时，切换到拥塞避免

```
cwnd: 1 → 2 → 4 → 8 → 16 → ... (指数增长)
```

##### 2. 拥塞避免（Congestion Avoidance）

- **触发**：cwnd ≥ ssthresh
- **规则**：每个 RTT，cwnd 增加 1 MSS（线性增长）
- **目的**：谨慎探测网络容量

```
cwnd: 16 → 17 → 18 → 19 → 20 → ... (线性增长)
```

##### 3. 快重传（Fast Retransmit）

- **触发**：收到 **3 个重复 ACK**
- **动作**：立即重传丢失的报文，不等待超时

```
发送方                           接收方
   | ─── [seq=1] ─────────────► |
   | ─── [seq=2] ─────── X      |  丢失
   | ─── [seq=3] ─────────────► |
   | ◄─── [ack=2] (重复1) ───── |
   | ─── [seq=4] ─────────────► |
   | ◄─── [ack=2] (重复2) ───── |
   | ─── [seq=5] ─────────────► |
   | ◄─── [ack=2] (重复3) ───── |
   |                             |
   | ─── [seq=2 重传] ─────────►|  立即重传
```

##### 4. 快恢复（Fast Recovery）

- **触发**：快重传之后
- **动作**：
  1. ssthresh = cwnd / 2
  2. cwnd = ssthresh（不从 1 开始）
  3. 进入拥塞避免阶段

#### 拥塞控制状态图

```
                     ┌─────────────────────┐
                     │      慢启动         │
                     │  cwnd 指数增长      │
                     └─────────┬───────────┘
                               │ cwnd ≥ ssthresh
                               ▼
                     ┌─────────────────────┐
                     │     拥塞避免        │
                     │  cwnd 线性增长      │
                     └─────────┬───────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │ 超时                 │ 3个重复ACK            │
        ▼                      ▼                      │
┌───────────────┐      ┌───────────────┐              │
│  ssthresh=cwnd/2│     │   快重传       │              │
│  cwnd = 1      │      │   快恢复       │              │
│  进入慢启动    │      │ ssthresh=cwnd/2│              │
└───────────────┘      │ cwnd=ssthresh  │              │
                       │ 进入拥塞避免   ├──────────────┘
                       └───────────────┘
```

---

## 重点对比总结

### TCP vs UDP

| 对比项 | TCP | UDP |
|--------|-----|-----|
| 连接 | 面向连接 | 无连接 |
| 可靠性 | 可靠传输 | 不可靠 |
| 有序性 | 保证顺序 | 不保证 |
| 首部大小 | 20 字节 + | 8 字节 |
| 流量控制 | ✅ 有 | ❌ 无 |
| 拥塞控制 | ✅ 有 | ❌ 无 |
| 传输模式 | 字节流 | 数据报 |
| 通信方式 | 一对一 | 一对多 |
| 速度 | 较慢 | 较快 |
| 应用 | HTTP、FTP、SMTP | DNS、视频、游戏 |

### 三次握手 vs 四次挥手

| 对比项 | 三次握手 | 四次挥手 |
|--------|----------|----------|
| 目的 | 建立连接 | 释放连接 |
| 次数 | 3 次 | 4 次 |
| 原因 | 第二次合并 SYN+ACK | 两个方向分别关闭 |
| 等待时间 | 无 | 2MSL |

---

## 常见考点速记

1. **传输层作用**：进程间通信、弥补网络层不可靠
2. **熟知端口范围**：0 ~ 1023
3. **UDP 首部**：8 字节
4. **TCP 首部**：20 字节（固定）
5. **三次握手标志**：SYN、SYN+ACK、ACK
6. **四次挥手标志**：FIN、ACK、FIN+ACK、ACK
7. **为什么三次握手**：防止失效请求、确认双方收发能力
8. **为什么四次挥手**：全双工需要分别关闭
9. **2MSL 等待原因**：确保 ACK 到达、旧报文消失
10. **慢启动**：cwnd 指数增长
11. **拥塞避免**：cwnd 线性增长
12. **快重传触发**：3 个重复 ACK
13. **流量控制**：滑动窗口、rwnd
14. **拥塞控制**：cwnd、ssthresh
