# 第3章 数据链路层协议

## 核心知识点

---

### 1. 数据链路层核心功能

#### 数据链路层概述

**数据链路层（Data Link Layer）**：OSI 模型第 2 层，负责在相邻节点之间可靠地传送帧。

> **核心目标**：在物理层提供的比特流传输基础上，建立可靠的数据传输服务。

#### 五大核心功能

| 功能 | 英文 | 描述 | 实现手段 |
|------|------|------|----------|
| **成帧** | Framing | 将网络层数据封装成帧，添加帧头和帧尾 | 字符计数法、字节填充、比特填充 |
| **差错检测** | Error Detection | 检测帧在传输过程中是否出错 | CRC（循环冗余校验）、奇偶校验 |
| **可靠交付** | Reliable Delivery | 确保帧能正确、按序到达 | 确认、重传机制（可选） |
| **媒体访问控制** | Media Access Control | 控制多个节点对共享信道的访问 | CSMA/CD、CSMA/CA、令牌环 |
| **流量控制** | Flow Control | 控制发送方发送速率，防止接收方缓冲区溢出 | 停-等协议、滑动窗口 |

#### 成帧方法

| 方法 | 描述 | 优缺点 |
|------|------|--------|
| **字符计数法** | 帧头用一个字段说明帧的字符数 | 简单，但计数出错会导致失步 |
| **字节填充法** | 用特殊字节标记帧的开始和结束 | 兼容性好，PPP 协议使用 |
| **比特填充法** | 用特殊比特序列标记帧边界 | 高效，HDLC、PPP 使用 |
| **物理层编码违例** | 利用物理层信号的非法编码来标记帧边界 | 依赖物理层，不够通用 |

---

### 2. PPP 协议的组成

#### PPP 协议概述

**PPP（Point-to-Point Protocol）**：点对点协议，用于在点对点链路上传输多种网络层协议的数据。

| 特性 | 描述 |
|------|------|
| **应用场景** | 拨号上网、宽带接入（PPPoE）、路由器间点对点连接 |
| **特点** | 简单、易于实现、支持多种网络层协议 |
| **层次位置** | 数据链路层协议 |

#### PPP 协议的三个组成部分

```
┌─────────────────────────────────────────────────────────────────┐
│                        PPP 协议组成                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │    PPP 帧格式    │  │  LCP（链路控制）  │  │  NCP（网络控制）  │  │
│  │                 │  │                 │  │                 │  │
│  │ 定义帧的封装    │  │ 建立、配置、     │  │ 为每种网络层    │  │
│  │ 格式            │  │ 测试、维护链路   │  │ 协议提供配置    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                   │
│                      ┌─────────────────┐                         │
│                      │   认证协议       │                         │
│                      │  PAP / CHAP     │                         │
│                      └─────────────────┘                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

| 组成部分 | 全称 | 功能 |
|----------|------|------|
| **帧格式** | PPP Frame | 定义帧的封装格式，支持透明传输 |
| **LCP** | Link Control Protocol | 建立、配置、测试和终止链路连接 |
| **NCP** | Network Control Protocol | 为不同网络层协议提供配置功能，如 IPCP |
| **认证协议** | PAP / CHAP | 对对端进行身份验证 |

---

### 3. PPP 帧格式各字段含义及透明传输实现

#### PPP 帧格式

```
 ┌─────────┬─────────┬─────────┬──────────┬─────────────┬───────┬──────────┐
 │  Flag   │ Address │ Control │ Protocol │   Payload   │  FCS  │   Flag   │
 │  1字节  │  1字节  │  1字节  │  2字节   │  ≤1500字节  │ 2字节 │   1字节  │
 │  7E     │   FF    │   03    │          │    数据     │       │    7E    │
 └─────────┴─────────┴─────────┴──────────┴─────────────┴───────┴──────────┘
```

#### 各字段含义

| 字段 | 长度 | 值 | 含义 |
|------|------|-----|------|
| **Flag（标志）** | 1 字节 | 0x7E | 帧定界符，标识帧的开始和结束 |
| **Address（地址）** | 1 字节 | 0xFF | 广播地址（PPP 是点对点，无需真正地址） |
| **Control（控制）** | 1 字节 | 0x03 | 无编号帧（PPP 不使用序号） |
| **Protocol（协议）** | 2 字节 | - | 指明 Payload 中的协议类型 |
| **Payload（信息）** | ≤1500 字节 | - | 上层数据（MTU 默认 1500） |
| **FCS（帧校验序列）** | 2/4 字节 | - | CRC 校验码 |

#### Protocol 字段常见值

| 值 | 协议 |
|-----|------|
| **0x0021** | IP 数据报 |
| **0x8021** | IPCP（IP 控制协议） |
| **0xC021** | LCP（链路控制协议） |
| **0xC023** | PAP（密码认证协议） |
| **0xC223** | CHAP（挑战握手认证协议） |

#### 透明传输的实现

由于 Flag 字段使用 0x7E 作为帧定界符，若数据中出现 0x7E，会被误认为帧边界。PPP 采用两种方法解决：

**1. 字节填充法（异步传输使用）**

| 原始数据 | 填充后 |
|----------|--------|
| 0x7E | 0x7D 0x5E（转义 + XOR 0x20） |
| 0x7D | 0x7D 0x5D（转义 + XOR 0x20） |
| 小于 0x20 的控制字符 | 0x7D (原值 XOR 0x20) |

```
发送方：若数据中出现 7E，替换为 7D 5E
        若数据中出现 7D，替换为 7D 5D
接收方：收到 7D 后，检查下一字节，还原原始数据
```

**2. 零比特填充法（同步传输使用）**

```
Flag 模式：01111110

发送方：扫描数据，遇到连续 5 个 1 后插入 0
        例：01111110 → 011111|0|10 （在第 5 个 1 后插入 0）
        
接收方：扫描数据，遇到连续 5 个 1 后删除后面的 0
```

---

### 4. LCP 协议的功能、报文种类

#### LCP 协议的功能

**LCP（Link Control Protocol）**：链路控制协议，负责 PPP 链路的建立、配置、测试和终止。

| 功能 | 描述 |
|------|------|
| **链路建立** | 协商链路参数（MRU、认证方式等） |
| **链路配置** | 协商各种链路选项 |
| **链路测试** | 发送 Echo 报文测试链路质量 |
| **链路终止** | 正常或异常关闭链路 |

#### LCP 报文种类

| 报文类型 | Code | 功能 | 阶段 |
|----------|------|------|------|
| **Configure-Request** | 1 | 发送配置选项请求 | 建立阶段 |
| **Configure-Ack** | 2 | 确认接受所有配置选项 | 建立阶段 |
| **Configure-Nak** | 3 | 拒绝某些选项值，提议新值 | 建立阶段 |
| **Configure-Reject** | 4 | 不识别或不接受某些选项 | 建立阶段 |
| **Terminate-Request** | 5 | 请求终止链路 | 终止阶段 |
| **Terminate-Ack** | 6 | 确认终止链路 | 终止阶段 |
| **Code-Reject** | 7 | 接收到无法识别的 LCP 报文 | 维护阶段 |
| **Protocol-Reject** | 8 | 接收到无法识别的协议 | 维护阶段 |
| **Echo-Request** | 9 | 测试链路 | 维护阶段 |
| **Echo-Reply** | 10 | 响应链路测试 | 维护阶段 |
| **Discard-Request** | 11 | 测试链路（无需响应） | 维护阶段 |

#### PPP 链路建立过程

```
┌─────────────────────────────────────────────────────────────────┐
│                     PPP 链路建立状态机                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────┐                                      ┌────────┐      │
│  │  Dead  │ ──── 物理层可用 ────────────────────→│Establish│      │
│  │ (断开) │                                      │ (建立)  │      │
│  └────────┘                                      └────┬───┘      │
│       ↑                                              │           │
│       │                                    LCP 协商成功          │
│       │                                              ↓           │
│       │                                      ┌────────────┐      │
│       ├──────────── 失败 ────────────────────│Authenticate│      │
│       │                                      │  (认证)    │      │
│       │                                      └────┬───────┘      │
│       │                                    认证成功 │             │
│       │                                              ↓           │
│       │                                      ┌────────────┐      │
│       ├──────────── 失败 ────────────────────│  Network   │      │
│       │                                      │ (网络配置) │      │
│       │                                      └────┬───────┘      │
│       │                                   NCP 配置成功           │
│       │                                              ↓           │
│       │                                      ┌────────────┐      │
│       └──────────── Terminate ───────────────│   Open     │      │
│                                              │  (已打开)  │      │
│                                              └────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

---

### 5. NCP 协议的功能，IPCP 协议的核心作用

#### NCP 协议的功能

**NCP（Network Control Protocol）**：网络控制协议族，为每种网络层协议提供独立的配置和控制。

| 特性 | 描述 |
|------|------|
| **多协议支持** | 每种网络层协议都有对应的 NCP |
| **独立配置** | 不同 NCP 可以独立启用/禁用 |
| **动态协商** | 协商网络层相关参数 |

#### 常见 NCP 协议

| NCP | 全称 | 对应网络层协议 |
|-----|------|----------------|
| **IPCP** | IP Control Protocol | IPv4 |
| **IPV6CP** | IPv6 Control Protocol | IPv6 |
| **IPXCP** | IPX Control Protocol | IPX（已过时） |
| **NBFCP** | NetBIOS Frames Control Protocol | NetBIOS |

#### IPCP 协议的核心作用

**IPCP（IP Control Protocol）**：IP 控制协议，用于协商 IP 层相关参数。

| 核心作用 | 描述 |
|----------|------|
| **IP 地址协商** | 动态协商接口 IP 地址 |
| **DNS 协商** | 协商主/备 DNS 服务器地址 |
| **压缩协商** | 协商 IP 头部压缩方式（如 Van Jacobson） |

#### IPCP 协商过程

```
┌────────────────────────────────────────────────────────────────┐
│  客户端                                              服务器    │
│     │                                                   │      │
│     │ ──── IPCP Configure-Request ────────────────────→ │      │
│     │      (请求 IP 地址: 0.0.0.0)                       │      │
│     │                                                   │      │
│     │ ←─── IPCP Configure-Nak ──────────────────────── │      │
│     │      (建议 IP: 192.168.1.100)                     │      │
│     │                                                   │      │
│     │ ──── IPCP Configure-Request ────────────────────→ │      │
│     │      (请求 IP: 192.168.1.100)                     │      │
│     │                                                   │      │
│     │ ←─── IPCP Configure-Ack ─────────────────────── │      │
│     │      (确认 IP: 192.168.1.100)                     │      │
│     │                                                   │      │
│     └───────────────── 链路可用 ─────────────────────→  │      │
└────────────────────────────────────────────────────────────────┘
```

---

### 6. PAP 与 CHAP 认证协议的流程、报文格式及安全性对比

#### PAP 认证协议

**PAP（Password Authentication Protocol）**：密码认证协议，采用两次握手方式。

##### PAP 认证流程

```
┌────────────────────────────────────────────────────────────────┐
│  被验证方 (Peer)                              验证方 (Authenticator)│
│        │                                                │       │
│        │ ──── Authenticate-Request ────────────────────→│       │
│        │      用户名 + 密码（明文）                       │       │
│        │                                                │       │
│        │ ←─── Authenticate-Ack / Nak ──────────────────│       │
│        │      成功 / 失败                                │       │
└────────────────────────────────────────────────────────────────┘
```

##### PAP 报文格式

| 字段 | 长度 | 描述 |
|------|------|------|
| Code | 1 字节 | 1=Request, 2=Ack, 3=Nak |
| Identifier | 1 字节 | 匹配请求与响应 |
| Length | 2 字节 | 报文总长度 |
| Peer-ID-Length | 1 字节 | 用户名长度 |
| Peer-ID | 可变 | 用户名 |
| Passwd-Length | 1 字节 | 密码长度 |
| Password | 可变 | 密码（**明文**） |

#### CHAP 认证协议

**CHAP（Challenge Handshake Authentication Protocol）**：挑战握手认证协议，采用三次握手方式。

##### CHAP 认证流程

```
┌────────────────────────────────────────────────────────────────┐
│  被验证方 (Peer)                              验证方 (Authenticator)│
│        │                                                │       │
│        │ ←──── Challenge ──────────────────────────────│       │
│        │       挑战值 (随机数) + 标识符                   │       │
│        │                                                │       │
│        │       计算: Hash(ID + 密码 + 挑战值)            │       │
│        │                                                │       │
│        │ ────→ Response ───────────────────────────────→│       │
│        │       哈希值 + 用户名                           │       │
│        │                                                │       │
│        │ ←──── Success / Failure ──────────────────────│       │
│        │       成功 / 失败                               │       │
└────────────────────────────────────────────────────────────────┘
```

##### CHAP 报文格式

| 字段 | 长度 | 描述 |
|------|------|------|
| Code | 1 字节 | 1=Challenge, 2=Response, 3=Success, 4=Failure |
| Identifier | 1 字节 | 匹配请求与响应，每次挑战递增 |
| Length | 2 字节 | 报文总长度 |
| Value-Size | 1 字节 | 挑战值/响应值长度 |
| Value | 可变 | 挑战值（随机数）或响应值（哈希值） |
| Name | 可变 | 主机名或用户名 |

#### PAP 与 CHAP 安全性对比

| 对比项 | PAP | CHAP |
|--------|-----|------|
| **认证方式** | 两次握手 | 三次握手 |
| **密码传输** | **明文传输** | 不传输密码，只传哈希值 |
| **重放攻击** | 易受攻击 | 抵抗重放攻击（每次挑战值不同） |
| **周期性验证** | 仅认证一次 | 可周期性重新认证 |
| **安全性** | **低** | **高** |
| **复杂度** | 简单 | 相对复杂 |
| **使用场景** | 低安全需求场景 | 推荐使用 |

> **重要提示**：由于 PAP 以明文传输密码，容易被窃听，**强烈建议使用 CHAP**。

---

### 7. 以太网协议帧格式及各字段含义

#### 以太网发展历程

| 标准 | 发布时间 | 特点 |
|------|----------|------|
| **DIX Ethernet V2** | 1982 | DEC、Intel、Xerox 联合发布，实际工业标准 |
| **IEEE 802.3** | 1983 | IEEE 标准化版本，与 DIX 略有不同 |

#### DIX Ethernet V2 帧格式（主流使用）

```
┌──────────┬────────────┬────────────┬────────┬─────────────┬───────┐
│ Preamble │ Dest MAC   │ Source MAC │  Type  │   Payload   │  FCS  │
│  8字节   │   6字节    │    6字节   │  2字节 │  46~1500    │ 4字节 │
├──────────┼────────────┼────────────┼────────┼─────────────┼───────┤
│   前导   │  目的MAC   │   源MAC    │ 类型   │    数据     │ 校验  │
└──────────┴────────────┴────────────┴────────┴─────────────┴───────┘
```

#### IEEE 802.3 帧格式

```
┌──────────┬────────────┬────────────┬────────┬────────┬─────────────┬───────┐
│ Preamble │ Dest MAC   │ Source MAC │ Length │  LLC   │   Payload   │  FCS  │
│  8字节   │   6字节    │    6字节   │  2字节 │ 头部   │  数据       │ 4字节 │
└──────────┴────────────┴────────────┴────────┴────────┴─────────────┴───────┘
```

#### 各字段含义

| 字段 | 长度 | DIX Ethernet V2 | IEEE 802.3 |
|------|------|-----------------|------------|
| **Preamble（前导码）** | 7 字节 | 同步时钟（1010...模式） | 同左 |
| **SFD（帧起始定界符）** | 1 字节 | 10101011，标识帧开始 | 同左 |
| **Dest MAC** | 6 字节 | 目的 MAC 地址 | 同左 |
| **Source MAC** | 6 字节 | 源 MAC 地址 | 同左 |
| **Type / Length** | 2 字节 | **类型**（上层协议） | **长度**（数据长度） |
| **Payload** | 46~1500 字节 | 实际数据，不足 46 字节需填充 | 包含 LLC 头部 |
| **FCS** | 4 字节 | CRC-32 校验 | 同左 |

#### Type 字段常见值（DIX Ethernet V2）

| 值 | 协议 |
|----|------|
| **0x0800** | IPv4 |
| **0x0806** | ARP |
| **0x86DD** | IPv6 |
| **0x8100** | VLAN（802.1Q） |
| **0x8864** | PPPoE |

#### 区分 DIX 与 IEEE 802.3 帧

| Type/Length 值 | 帧类型 |
|----------------|--------|
| ≤ 1500 (0x05DC) | IEEE 802.3（表示长度） |
| ≥ 1536 (0x0600) | DIX Ethernet V2（表示类型） |

> **实际应用**：目前绝大多数以太网使用 **DIX Ethernet V2** 格式。

---

### 8. MAC 地址的结构、表示方法及分类

#### MAC 地址概述

**MAC（Media Access Control）地址**：也称物理地址、硬件地址，用于在局域网中唯一标识网络设备。

| 特性 | 描述 |
|------|------|
| **长度** | 48 位（6 字节） |
| **唯一性** | 全球唯一（理论上） |
| **固化位置** | 烧录在网卡的 ROM 中 |
| **作用范围** | 局域网内有效 |

#### MAC 地址结构

```
┌──────────────────────────────────────────────────────────────────┐
│                        48 位 MAC 地址                             │
├──────────────────────────────┬───────────────────────────────────┤
│         OUI（24位）           │          NIC（24位）              │
│    组织唯一标识符              │       网络接口标识符              │
│    (厂商代码)                  │       (设备序列号)                │
└──────────────────────────────┴───────────────────────────────────┘

OUI 第一字节的最低两位含义：
┌─────────────────────────────────────────────┐
│  b7 b6 b5 b4 b3 b2 b1 b0                    │
│                       │  └─ I/G 位          │
│                       └──── U/L 位          │
└─────────────────────────────────────────────┘
```

| 位 | 名称 | 值=0 | 值=1 |
|-----|------|------|------|
| **I/G（第0位）** | Individual/Group | 单播地址 | 组播/广播地址 |
| **U/L（第1位）** | Universal/Local | 全球管理（IEEE分配） | 本地管理（自定义） |

#### MAC 地址表示方法

| 表示法 | 格式 | 示例 |
|--------|------|------|
| **冒号分隔** | XX:XX:XX:XX:XX:XX | 00:1A:2B:3C:4D:5E |
| **连字符分隔** | XX-XX-XX-XX-XX-XX | 00-1A-2B-3C-4D-5E |
| **无分隔** | XXXXXXXXXXXX | 001A2B3C4D5E |
| **点分隔（Cisco）** | XXXX.XXXX.XXXX | 001A.2B3C.4D5E |

#### MAC 地址分类

| 类型 | 特征 | 示例 | 用途 |
|------|------|------|------|
| **单播地址** | I/G=0，唯一标识一个设备 | 00:1A:2B:3C:4D:5E | 点对点通信 |
| **组播地址** | I/G=1，标识一组设备 | 01:00:5E:xx:xx:xx | 组播通信（如 OSPF） |
| **广播地址** | 全 1 | FF:FF:FF:FF:FF:FF | 向所有设备发送 |

#### 特殊 MAC 地址

| 地址 | 用途 |
|------|------|
| **FF:FF:FF:FF:FF:FF** | 广播地址，向局域网内所有设备发送 |
| **01:00:5E:xx:xx:xx** | IPv4 组播地址映射 |
| **33:33:xx:xx:xx:xx** | IPv6 组播地址映射 |
| **01:80:C2:00:00:00** | STP（生成树协议）组播 |

#### 单播、组播、广播对比

| 类型 | 发送方 | 接收方 | 目的 MAC | 应用场景 |
|------|--------|--------|----------|----------|
| **单播** | 一个 | 一个 | 目标设备 MAC | 普通点对点通信 |
| **组播** | 一个 | 多个（一组） | 组播 MAC | OSPF、视频会议 |
| **广播** | 一个 | 所有 | FF:FF:FF:FF:FF:FF | ARP 请求、DHCP 发现 |

---

## 重点对比总结

### PPP vs 以太网

| 对比项 | PPP | 以太网 |
|--------|-----|--------|
| **拓扑** | 点对点 | 总线/星型 |
| **地址字段** | 固定 0xFF（无意义） | 需要 MAC 地址 |
| **介质访问控制** | 不需要（只有两个端点） | CSMA/CD |
| **认证** | 支持（PAP/CHAP） | 不支持 |
| **多协议支持** | 通过 NCP 支持 | 通过 Type 字段指示 |

### PAP vs CHAP

| 对比项 | PAP | CHAP |
|--------|-----|------|
| **密码传输** | 明文 | 不传输，只传哈希 |
| **握手次数** | 两次 | 三次 |
| **安全性** | 低 | 高 |
| **重放攻击** | 易受攻击 | 可抵御 |
| **周期验证** | 不支持 | 支持 |

### DIX Ethernet V2 vs IEEE 802.3

| 对比项 | DIX Ethernet V2 | IEEE 802.3 |
|--------|-----------------|------------|
| **Type/Length 字段** | 表示上层协议类型 | 表示数据长度 |
| **LLC 头部** | 无 | 有 |
| **实际使用** | 主流 | 较少使用 |
| **识别方法** | Type ≥ 1536 | Length ≤ 1500 |

---

## 常见考点速记

1. **数据链路层五大功能**：成帧、差错检测、可靠交付、媒体访问控制、流量控制
2. **PPP 三大组成**：帧格式、LCP、NCP
3. **PPP 帧标志字节**：0x7E
4. **透明传输**：字节填充（0x7D 转义）、零比特填充（连续 5 个 1 后插 0）
5. **LCP 功能**：建立、配置、测试、终止链路
6. **IPCP 核心作用**：协商 IP 地址和 DNS
7. **PAP 安全隐患**：密码明文传输
8. **CHAP 优势**：不传密码、抵御重放攻击、支持周期验证
9. **MAC 地址长度**：48 位（6 字节）
10. **广播 MAC**：FF:FF:FF:FF:FF:FF
11. **以太网 MTU**：1500 字节
12. **DIX vs 802.3 区分**：Type/Length 字段值 ≥1536 为 DIX，≤1500 为 802.3
